<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">

    <script type="text/javascript" src="lib/jquery.min.js"></script>
    <script type="text/javascript" src="lib/osql.js"></script>
    <link rel="stylesheet" href="style.css">

    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script> <!-- Plotly.jsのCDNを追加 -->

    <title>AdminTop</title>
    <script>
        osql.requireLogin();

        var me;
        var studentid;

        $().ready(function () {
            getProfile();
            getUsers();
        })

        async function getProfile() {
            // プロフフィールの取得
            me = await osql.getMe();
            studentid = me.studentid;
            console.log(me);
        }

        async function getUsers() {
            // User一覧を取得
            var sql = 'select * from Users';
            var users = await osql.connect(sql);
            var html = '';
            html = html + '<table border="1">';
            for (var i = 0; i < users.length; i++) {
                html = html + '<tr>';
                var user = users[i];
                html = html + '<td>' + user.studentid + '</td>';
                html = html + '<td>' + user.name + '</td>';
                html = html + `<td><button type="button" onclick="display('` + user.studentid + `')">表示</button></td>`;
                html = html + '</tr>';
            }
            html = html + '</table>';
            document.getElementById('users').innerHTML = html;
        }

        async function display(studentid) {
            // 選択された人のデータを表示する
            var sql = `select * from Users where studentid = "${studentid}";`;
            var objects = await osql.connect(sql);
            var name = objects[0].name;
            document.getElementById('name').innerHTML = `${name} さんのデータ`;
            updatePlot(studentid);
            updateTable(studentid);
        }

        async function updatePlot(studentid) {
            // プロットを更新
            var sql = `select * from Troubles where studentid = "${studentid}" ORDER BY createdat DESC LIMIT 20;;`;
            var objects = await osql.connect(sql);
            objects.reverse();  // データを逆順に配置

            // バージョンをx軸、悩み度をy軸としてデータを作成
            var data = [{
                x: objects.map((obj, index) => index + 1),
                y: objects.map(obj => obj.trouble),
                type: 'bar',
                hovertemplate: '%{text.trouble}<br>%{text.createdat}',  // カーソルを当てたときの表示テンプレート
                text: objects.map(obj => ({ trouble: obj.trouble, createdat: obj.createdat }))  // 表示するテキストデータ
            }];

            var layout = {
                xaxis: {
                    title: 'バージョン',
                },
                yaxis: {
                    title: '悩み度',
                    range: [1, 5]  // y軸の範囲を1から5に固定
                },
            };

            Plotly.newPlot('plot', data, layout);
        }

        async function updateTable(studentid) {
            // 表を更新
            var sql = `SELECT * FROM Troubles where studentid = "${studentid}" order by createdat desc;`;
            var objects = await osql.connect(sql);

            var html = '';
            html = html + '<table border="1">';
            html = html + '<tr>';
            html = html + '<th>悩み度</th>';
            html = html + '<th>時間</th>';
            html = html + '<th>メモ</th>';
            html = html + '</tr>';

            for (var i = 0; i < objects.length; i++) {
                var object = objects[i];

                html = html + '<tr>';
                html = html + '<td>' + object.trouble + '</td>';
                html = html + '<td>' + object.createdat + '</td>';
                html = html + '<td>' + object.memo + '</td>';
                html = html + '</tr>';
            }

            html = html + '</table>';
            document.getElementById('table').innerHTML = html;
        }

        function logout() {
            osql.logout();
        }
    </script>
</head>

<body>
    <div class="container">
        <h1>悩み度測定記録</h1>
        <p>学生一覧</p>
        <div id="users"></div> <!-- 学生一覧を表示 -->
        <h4 id="name"></h4>
        <div id="plot"></div> <!-- プロットを表示 -->
        <div id="table"></div> <!-- 表を表示 -->
    </div>
</body>

</html>