<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">

    <script type="text/javascript" src="lib/jquery.min.js"></script>
    <script type="text/javascript" src="lib/osql.js"></script>
    <link rel="stylesheet" href="style.css">

    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script> <!-- Plotly.jsのCDNを追加 -->

    <title>Top</title>
    <script>
        osql.requireLogin();

        var me;
        var studentid;

        $().ready(function () {
            getProfile();
            clearMemo();  // メモ欄をクリア
            updatePlot();  // プロットを初期表示
            updareTable();  // 表を表示
        })

        async function getProfile() {
            // プロフフィールの取得
            me = await osql.getMe();
            studentid = me.studentid;
            document.getElementById('user_name').innerHTML = `${me.fname} さん`;
            console.log(me);
        }

        var minutes = 0;
        var seconds = 0;
        var timer;
        var showAlertInterval;
        var state = '停止中';
        var ontime = false;
        var soundEnabled = true;

        function start() {
            // startボタンが押されたとき
            ontime = true;
            if (ontime == true) {
                // startButtonの無効化
                var startButton = document.getElementById("startButton");
                startButton.disabled = true;
                // startメッセージの表示
                var startTime = new Date();
                var startTimeMessage = "開始しました (" + getFormattedDateTime(startTime) + ")";
                document.getElementById("message").innerHTML = startTimeMessage;
                // document.getElementById("messeage").innerHTML = "開始しました";
                // finishButtonの有効化
                var finishButton = document.getElementById("finishButton");
                finishButton.disabled = false;
            }
            // タイマーを開始
            startTimer();
            // 15分ごとにアラートを表示する
            showAlertInterval = setInterval(function () {
                showAlert();
            }, 15 * 60 * 1000);
        }

        function finish() {
            // finishボタンが押されたとき
            ontime = false;
            if (ontime == false) {
                // finishButtonの無効化
                var finishButton = document.getElementById("finishButton");
                finishButton.disabled = true;
                // finishメッセージの表示
                var finishTime = new Date();
                var finishTimeMessage = "終了しました (" + getFormattedDateTime(finishTime) + ")";
                document.getElementById("message").innerHTML = finishTimeMessage;
                // startButtonの有効化
                var startButton = document.getElementById("startButton");
                startButton.disabled = false;
            }
            // タイマーを停止
            clearInterval(timer);
            clearInterval(showAlertInterval);
        }

        function getFormattedDateTime(date) {
            var year = date.getFullYear();
            var month = addLeadingZero(date.getMonth() + 1);
            var day = addLeadingZero(date.getDate());
            var hours = addLeadingZero(date.getHours());
            var minutes = addLeadingZero(date.getMinutes());
            var seconds = addLeadingZero(date.getSeconds());
            return year + "-" + month + "-" + day + " " + hours + ":" + minutes + ":" + seconds;
        }

        function addLeadingZero(number) {
            return number < 10 ? "0" + number : number;
        }

        function toggleTimerDisplay() {
            // タイマーの表示/非表示の切り替え
            var timerCheckbox = document.getElementById("timerCheckbox");
            var timerElement = document.getElementById("time");

            if (timerCheckbox.checked) {
                timerElement.style.display = "block";
            } else {
                timerElement.style.display = "none";
            }
        }

        function toggleSound() {
            // サウンドのオン/オフの切り替え
            var soundToggle = document.getElementById("soundToggle");
            soundEnabled = soundToggle.checked;
        }

        function startTimer() {
            // 分数と秒数をリセット
            minutes = 0;
            seconds = 0;
            // タイマーを開始
            if (state == '停止中') {
                timer = setInterval(updateTimer, 1000);
                state = '動作中';
            } else if (state == '動作中') {
                clearInterval(timer);
                state = '停止中';
            }
        }

        function updateTimer() {
            // タイマーの表示を更新する関数
            seconds++;
            if (seconds >= 60) {
                seconds = 0;
                minutes++;
            }
            document.getElementById('minutes').innerHTML = addLeadingZero(minutes);
            document.getElementById('seconds').innerHTML = addLeadingZero(seconds);
        }

        function showAlert() {
            // アラートの表示
            alert('15分経過しました! 悩み度を送信してください!');

            // サウンドを再生する
            if (soundEnabled) {
                var audio = new Audio('sound.mp3');
                audio.play();
            }
        }

        function submit() {
            // 送信ボタンが押されたとき
            var selectedValue = getTroubleLevel();  // トラブルレベルの値を取得
            var submittedMemo = getMemo();

            // 選択されていないときにメッセージの表示
            var submitTime = new Date();
            if (!selectedValue) {
                var reselectMessage = "値を選択して送信してください (" + getFormattedDateTime(submitTime) + ")";
                document.getElementById("submitResult").innerHTML = reselectMessage;
                document.getElementById("submitResult").style.color = 'red'; // 赤色に設定
                return;
            }

            insertTroubleLevel(selectedValue, submittedMemo);  // データベースに追加
            clearMemo();  // メモ欄をクリア
            updatePlot();  // プロットを更新
            updareTable();  // 表を更新

            var submitResultMessage = "送信されました (" + getFormattedDateTime(submitTime) + ")";
            document.getElementById("submitResult").innerHTML = submitResultMessage;
            document.getElementById("submitResult").style.color = 'black'; // 黒色に設定
        }

        function getTroubleLevel() {
            // 選択されたトラブルレベルを取得
            var selectedRadio = document.querySelector('input[name="trouble"]:checked');
            if (selectedRadio) {
                return selectedRadio.value;
            }
            return null; // 選択された値がない場合は null を返す
        }

        function getMemo() {
            // 入力されたメモを取得
            var submittedMemo = document.getElementById("memo").value;
            return submittedMemo;
        }

        function clearMemo() {
            // メモ欄をクリア
            document.getElementById('memo').value = "";
        }

        async function insertTroubleLevel(value, memo) {
            console.log(memo);
            // トラブルレベルをTroublesテーブルに追加
            var sql = `insert into Troubles(studentid, trouble, createdat, memo) values("${studentid}", "${value}", now(), "${memo}");`;
            var objects = await osql.connect(sql);
            var selectSql = `select * from Troubles where studentid = "${studentid}" and createdat =  now();`;
            var selectobjects = await osql.connect(selectSql);
        }

        async function updatePlot() {
            me = await osql.getMe();
            studentid = me.studentid;
            // プロットを更新する関数
            var sql = `select * from Troubles where studentid = "${studentid}";`;
            var objects = await osql.connect(sql);

            var data = [{
                x: objects.map(obj => obj.createdat), // x軸にcreatedatを設定
                y: objects.map(obj => obj.trouble), // y軸にtroubleを設定
                type: 'scattergl', // プロットの種類を指定
                mode: 'lines+markers', // ラインとマーカーの両方を表示
                marker: { size: 8 }, // マーカーのサイズを指定
                line: { shape: 'linear' } // ラインの種類を指定
            }];

            var layout = {
                xaxis: { title: '時間' }, // x軸のラベルを設定
                yaxis: { title: '悩み度' } // y軸のラベルを設定
            };

            Plotly.newPlot('plot', data, layout); // プロットを作成
        }

        async function updareTable() {
            me = await osql.getMe();
            studentid = me.studentid;
            var sql = `SELECT * FROM Troubles where studentid = "${studentid}" order by createdat desc;;`;
            var objects = await osql.connect(sql);

            var html = '';
            html = html + '<table border="1">';
            html = html + '<tr>';
            html = html + '<th>悩み度</th>';
            html = html + '<th>時間</th>';
            html = html + '<th>メモ</th>';
            html = html + '</tr>';

            for (var i = 0; i < objects.length; i++) {
                var object = objects[i];

                html = html + '<tr>';
                html = html + '<td>' + object.trouble + '</td>';
                html = html + '<td>' + object.createdat + '</td>';
                html = html + '<td>' + object.memo + '</td>';
                html = html + '</tr>';
            }

            html = html + '</table>';
            document.getElementById('table').innerHTML = html;
        }
    </script>
</head>

<body>
    <div class="container">
        <h1>troubleMeasurement</h1>
        <p id="user_name"></p>
        <button onclick="start()" id="startButton">Start</button>
        <button onclick="finish()" id="finishButton" disabled>Finish</button>
        <p id="message"></p> <input type="checkbox" id="timerCheckbox" onchange="toggleTimerDisplay()" checked>
        <label>タイマー表示/非表示</label>
        <input type="checkbox" id="soundToggle" onchange="toggleSound()" checked>
        <label for="soundToggle">サウンドオン/オフ</label>
        <p id="time"><span id="minutes">00</span>:<span id="seconds">00</span></p>
        <table>
            <tr>
                <td>
                    <input type="radio" name="trouble" value=1>
                </td>
                <td>
                    <input type="radio" name="trouble" value=2>
                </td>
                <td>
                    <input type="radio" name="trouble" value=3>
                </td>
                <td>
                    <input type="radio" name="trouble" value=4>
                </td>
                <td>
                    <input type="radio" name="trouble" value=5>
                </td>
            </tr>
            <tr>
                <td align="center">1</td>
                <td align="center">2</td>
                <td align="center">3</td>
                <td align="center">4</td>
                <td align="center">5</td>
            </tr>
        </table>
        <div class="memo-container">
            <input id="memo" value="" type="textfield" placeholder="Memo">
        </div>
        <br>
        <button onclick="submit()">送信</button>
        <p id="submitResult"></p>
        <div id="plot"></div> <!-- プロットを表示 -->
        <div id="table"></div> <!-- 表を表示 -->
    </div>
</body>

</html>