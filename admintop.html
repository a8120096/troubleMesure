<!DOCTYPE html>
<html lang="en">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">

    <script type="text/javascript" src="lib/jquery.min.js"></script>
    <script type="text/javascript" src="lib/osql.js"></script>
    <link rel="stylesheet" href="style.css">

    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script> <!-- Plotly.jsのCDNを追加 -->

    <title>分析・学生一覧</title>
    <script>
        osql.requireLogin();

        var me;
        var teacherid;
        var selectedStudents;

        $().ready(function () {
            getProfile();
            getUsers();
            selectedStudents = [];
        })

        async function getProfile() {
            // プロフフィールの取得
            me = await osql.getMe();
            teacherid = me.studentid;
        }

        async function getUsers() {
            // User一覧を取得
            var sql = 'select * from Users';
            var users = await osql.connect(sql);

            var html = '';
            html = html + '<table border="1">';
            for (var i = 0; i < users.length; i++) {
                html = html + '<tr>';
                var user = users[i];
                html = html + '<td>' + user.studentid + '</td>';
                html = html + '<td>' + user.name + '</td>';
                html = html + `<td><input type="checkbox" onchange="updateSelectedStudents('${user.studentid}', this)"></td>`;
                html = html + '</tr>';
            }
            html = html + '</table>';
            html = html + '<button onclick="allCheck()" id="allCheckButton">全員を選択</button>';
            document.getElementById('users').innerHTML = html;
        }

        function allCheck() {
            // 全員を選択するボタンが押されたとき
            var checkboxes = document.querySelectorAll('input[type="checkbox"]');
            selectedStudents = []; // selectedStudents配列をリセット
            for (var i = 0; i < checkboxes.length; i++) {
                var checkbox = checkboxes[i];
                checkbox.checked = true;
                var studentid = checkbox.parentNode.parentNode.cells[0].innerText; // チェックボックスの親要素のセルからstudentidを取得
                updateSelectedStudents(studentid, checkbox);
            }
        }

        function updateSelectedStudents(studentid, checkbox) {
            // チェックボックスのチェック状態に応じてselectedStudents配列を更新
            if (checkbox.checked) {
                // チェックされた時は配列に追加
                selectedStudents.push(studentid);
            } else {
                // チェックが外された時は配列から削除
                var index = selectedStudents.indexOf(studentid);
                if (index != -1) {
                    selectedStudents.splice(index, 1);
                }
            }
        }

        async function displaySelectedStudent() {
            // 選択された生徒のデータ一覧を表示
            var html = '';
            document.getElementById('plots').innerHTML = ''; // プロットのコンテナをクリア

            for (var i = 0; i < selectedStudents.length; i++) {
                var selectedStudentid = selectedStudents[i];
                // 名前を取得
                var nameSql = `select name from Users where studentid = "${selectedStudentid}";`;
                var nameObjects = await osql.connect(nameSql);
                var name = nameObjects[0].name;

                // htmlを用意
                Shtml = '<div class="cardContent"><div id="' + selectedStudentid + '" class="box">';
                htmlName = `<h4><a href="detail.html?studentid=` + selectedStudentid + `" target="_blank">${name}</a> さん</h4>`;
                htmlPlot = '<div class="plotArea"><div id="' + selectedStudentid + 'Plot"></div></div>';
                htmlLastTime = '<div id="' + selectedStudentid + 'LastTime"></div>';
                htmlLastMemo = '<div id="' + selectedStudentid + 'LastMemo"></div>';
                Ehtml = '</div></div>';
                html = Shtml + htmlName + htmlPlot + htmlLastTime + htmlLastMemo + Ehtml;
                document.getElementById('plots').innerHTML += html;

                // 最後の時間を取得
                var timeSql = `select createdat from Troubles where studentid = "${selectedStudentid}" ORDER BY createdat DESC LIMIT 1;`;
                var timeObjects = await osql.connect(timeSql);
                var lastTime = timeObjects[0].createdat;

                // 最後のメモを取得
                var memoSql = `select memo from Troubles where studentid = "${selectedStudentid}" ORDER BY createdat DESC LIMIT 1;;`;
                var memoObjects = await osql.connect(memoSql);
                var lastMemo = memoObjects[0].memo;

                updatePlot(selectedStudentid);  // プロットを更新
                document.getElementById(selectedStudentid + "LastTime").innerHTML = lastTime;
                document.getElementById(selectedStudentid + "LastMemo").innerHTML = lastMemo;
            }
        }

        async function updatePlot(studentid) {
            // プロットを更新
            var sql = `select * from Troubles where studentid = "${studentid}" ORDER BY createdat DESC LIMIT 20;`;
            var objects = await osql.connect(sql);
            objects.reverse();  // データを逆順に配置

            // バージョンをx軸、悩み度をy軸としてデータを作成
            var data = [{
                x: objects.map((obj, index) => index + 1),
                y: objects.map(obj => obj.trouble),
                type: 'bar',
                hovertemplate: '%{text.trouble}<br>%{text.createdat}',  // カーソルを当てたときの表示テンプレート
                text: objects.map(obj => ({ trouble: obj.trouble, createdat: obj.createdat }))  // 表示するテキストデータ
            }];

            var layout = {
                xaxis: {
                    title: 'バージョン',
                },
                yaxis: {
                    title: '悩み度',
                    range: [1, 5]  // y軸の範囲を1から5に固定
                },
                margin: {
                    l: 50,  // 左側の余白
                    r: 50,  // 右側の余白
                    t: 50,  // 上側の余白
                    b: 50   // 下側の余白
                },
                width: 350,
                height: 250
            };

            Plotly.newPlot(studentid + 'Plot', data, layout);
        }

        async function updateTable(studentid) {
            // 表を更新
            var sql = `SELECT * FROM Troubles where studentid = "${studentid}" order by createdat desc;;`;
            var objects = await osql.connect(sql);

            var html = '';
            html = html + '<table border="1">';
            html = html + '<tr>';
            html = html + '<th>悩み度</th>';
            html = html + '<th>時間</th>';
            html = html + '<th>メモ</th>';
            html = html + '</tr>';

            for (var i = 0; i < objects.length; i++) {
                var object = objects[i];

                html = html + '<tr>';
                html = html + '<td>' + object.trouble + '</td>';
                html = html + '<td>' + object.createdat + '</td>';
                html = html + '<td>' + object.memo + '</td>';
                html = html + '</tr>';
            }

            html = html + '</table>';
            document.getElementById('table').innerHTML = html;
        }

        function logout() {
            osql.logout();
        }
    </script>
</head>

<body>
    <div class="container">
        <table width="100%">
            <tr>
                <td>
                    <h1>悩み度測定記録</h1>
                </td>
                <td align="right"><a href="javascript:logout()">ログアウト</a></td>
            </tr>
        </table>
        <hr>
        <h4>学生一覧</h4>
        <div id="users"></div> <!-- 学生一覧を表示 -->
        <button onclick="displaySelectedStudent()" class="bigButton">選択した生徒を表示</button>
        <hr>
        <h4>悩み度一覧</h4>
        <div id="plots">
            <div class="card"></div>
        </div> <!-- プロットを表示 -->
    </div>
</body>

</html>